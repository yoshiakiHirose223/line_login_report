# 終業報告　2021/09/16
## 取り組んだ作業
- ログイン状態の保持の実装
  - $_SESSION['user_id']が空かどうかで判断
- ログアウトの実装
  - $_SESSIONに空の配列を入れてリセット
  - LINE APIを叩いてアクセストークンの取り消し処理を行う
- エラー対応
  - ユーザーが認可を拒否した場合や、CSRF対策の`state`が不一致だった場合、簡易的なエラー画面を表示しやり直しを求めるように実装
- LINE APIを叩く関数、DB操作が必要な関数、コールバックから呼び出すための関数など分類しファイル分け

## 学んだこと・気づいたこと
- $_SESSIONのリセット方法
  - $_SESSIONの内容をリセットさせたい場合には`unset()`や空の配列を入れるなどの処理を行う
- `header('Location: hoge.php')`の処理が走るとすぐにページ遷移するものだと思っていたが、実際には実行されているphpファイルの処理が全て終わってからであった。
- 関数の役割分担をすることでどの関数をどのファイルに書くべきか分かりやすくなり、作業効率の向上とエラーの修正がやりやすくなった。綺麗にコードを書くことの大切さを少しは実感できた。


## 次回予定
- エラーレスポンスが返ってくる可能性のある箇所について、エラー発生時の処理を書いていく
- session.phpにて$_SESSIONを返す関数がいくつかあるが、何も格納されていない状態で呼び出すと`Undefined index`となるので期待通りに動くよう修正する
- 松島メンターから送っていただいたサイトを参考にディレクトリ構成を変えてみる

##　質問
### ログイン失敗時のエラー対応でif文のネストが深くなってしまう
`line_callback.php`にてログイン処理を行なっているのですが、エラーが発生しそうな点が多く、その分ネストしてしまいます(下記部分)。エラー発生時の分岐処理は`line_functions.php`で行なった方がよろしいでしょうか？改善する方法などがあれば教えて頂きたいです。

```php
<?php
require_once('line_functions.php');
require_once('session.php');

//CSRF対策でstateが一致するか検証
if ($_GET['state'] === getStateFromSession()) {
    //ユーザーが権限について同意したか検証(同意なし→$_GET['code']がクエリパラメータに付かず、$_GET['error']が送られる)
    if (isset($_GET['code'])) {
        //PKCE対応の`code_verifier`が正しいか検証
        $accessTokenJson = getAccessTokenJson();
        //受け取ったIDトークンが悪意あるユーザーからのものでないか検証
        $checkedIdTokenJson = getCheckedIdTokenJson($accessTokenJson->id_token);
        registerUserIfNeeded($checkedIdTokenJson->aud);
        storeUserInfoInSession(
            $checkedIdTokenJson->aud,
            $accessTokenJson->access_token
        );
        header('Location: ./index.php');
    } else {
        storeLoginErrorInSession($_GET['error']);
    }
} else {
    storeLoginErrorInSession('invalid state');
}

if (!is_null(getLoginErrorFromSession())) {
    header('Location: ./login_error.php');
}

```

### どこからでも取得できる値を関数で使う場合は、その値をどこで呼び出すべきか？
例えば、アクセストークンを取得する場合`$_GET['code']`を使いたいのですが、これを呼び出し元ではなく実行元(?)で`$_GET['code']`を呼び出しています。
このような実装(①)か、または呼び出し元で引数に渡して行く実装(②)のどちらの方が良い又はよく使われる手段なのでしょうか？

①
```php
$accessTokenJson = getAccessTokenJson();

function getAccessTokenJson()
{
    $accessToken = requestAccessToken();
    return json_decode($accessToken);
}

function requestAccessToken()
{
    $requestTokenUrl = 'https://api.line.me/oauth2/v2.1/token';
    $param = [
        'grant_type'    => 'authorization_code',
        'code'          => $_GET['code'],
//省略
}

```

②
```php
$accessTokenJson = getAccessTokenJson($GET['code']);

function getAccessTokenJson($code)
{
    $accessToken = requestAccessToken($code);
    return json_decode($accessToken);
}

function requestAccessToken($code)
{
    $requestTokenUrl = 'https://api.line.me/oauth2/v2.1/token';
    $param = [
        'grant_type'    => 'authorization_code',
        'code'          => $code,
//省略
}

```